<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Live Leaderboard</title>

  <style>
    body {
      font-family: Arial;
      background: #f4f7f9;
      padding: 20px;
    }

    table {
      width: 95%;
      margin: auto;
      border-collapse: collapse;
      background: white;
    }

    th, td {
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid #ddd;
    }

    thead {
      background: #1f6feb;
      color: white;
    }

    /* ---------- FLIP animation ---------- */
    tr {
      will-change: transform;
    }

    /* ---------- Score arrows ---------- */
    .score-move {
      font-size: 12px;
      font-weight: bold;
      margin-left: 6px;
    }

    .score-up {
      color: #16a34a; /* green */
    }

    .score-down {
      color: #dc2626; /* red */
    }

    /* ---------- Controls ---------- */
    .controls {
      width: 95%;
      margin: 10px auto;
      display: flex;
      justify-content: space-between;
    }

    input {
      padding: 8px;
      width: 280px;
    }

    button {
      padding: 8px 14px;
      margin: 0 4px;
    }
  </style>
</head>

<body>

<h2 style="text-align:center;">Live Portfolio Leaderboard</h2>

<div class="controls">
  <input
    type="text"
    id="search"
    placeholder="Search by Portfolio ID..."
    oninput="applyFilter()"
  />

  <div style="display:flex; align-items:center; gap:12px;">
    <span id="last-updated" style="font-size:13px; color:#555;">
      Last Updated: —
    </span>
    <button onclick="manualRefresh()">Refresh</button>
    <button onclick="prevPage()">Prev</button>
    <span id="page-info"></span>
    <button onclick="nextPage()">Next</button>
  </div>
</div>

<table>
  <thead>
    <tr>
      <th>Rank</th>
      <th>Portfolio ID</th>
      <th>Composite Score</th>
      <th>Avg Return</th>
      <th>Sharpe</th>
      <th>Sortino</th>
    </tr>
  </thead>
  <tbody id="tbl"></tbody>
</table>

<script>
  const ws = new WebSocket(
    (location.protocol === "https:" ? "wss:" : "ws:") +
    "//" + location.host + "/ws/updates"
  );

  let board = {};
  let prevScores = {};
  let scoreDirection = {}; // pid -> "up" | "down"
  let filtered = [];
  let page = 1;
  const pageSize = 20;

  /* ---------- Time ---------- */
  function formatNow() {
    const d = new Date();
    return (
      d.toLocaleTimeString() +
      "." +
      String(d.getMilliseconds()).padStart(3, "0")
    );
  }

  /* ---------- FLIP helpers ---------- */
  function capturePositions() {
    const rows = document.querySelectorAll("#tbl tr");
    const map = {};
    rows.forEach(r => {
      map[r.dataset.pid] = r.getBoundingClientRect();
    });
    return map;
  }

  function playFLIP(prevPositions) {
    const rows = document.querySelectorAll("#tbl tr");

    rows.forEach(row => {
      const pid = row.dataset.pid;
      const oldPos = prevPositions[pid];
      if (!oldPos) return;

      const newPos = row.getBoundingClientRect();
      const dy = oldPos.top - newPos.top;

      if (Math.abs(dy) > 1) {
        row.style.transform = `translateY(${dy}px)`;
        row.style.transition = "transform 0s";

        requestAnimationFrame(() => {
          row.style.transform = "";
          row.style.transition = "transform 450ms ease";
        });
      }
    });
  }

  /* ---------- WebSocket ---------- */
  ws.onmessage = (evt) => {
    const msg = JSON.parse(evt.data);

    if (msg.event === "leaderboardSnapshot") {
      applySnapshot(msg.top);
      applyFilter();

      document.getElementById("last-updated").innerText =
        "Last Updated: " + formatNow();
    }
  };

  /* ---------- Snapshot ---------- */
  function applySnapshot(list) {
    list.forEach(u => {
      const prev = board[u.portfolioId]?.score ?? null;

      if (prev !== null && prev !== u.compositeScore) {
        scoreDirection[u.portfolioId] =
          u.compositeScore > prev ? "up" : "down";
      }

      prevScores[u.portfolioId] = prev;

      board[u.portfolioId] = {
        pid: u.portfolioId,
        rank: u.rank,
        score: u.compositeScore,
        avg: u.avgReturn,
        sharpe: u.sharpe,
        sortino: u.sortino
      };
    });
  }

  /* ---------- Filtering ---------- */
  function applyFilter() {
    const search = document.getElementById("search").value.toLowerCase();

    filtered = Object.values(board)
      .sort((a, b) => b.score - a.score)
      .filter(r => r.pid.toLowerCase().includes(search));

    renderTable();
  }

  /* ---------- Rendering ---------- */
  function renderTable() {
    const tbl = document.getElementById("tbl");
    const prevPositions = capturePositions();

    const startIndex = (page - 1) * pageSize;
    const pageData = filtered.slice(startIndex, startIndex + pageSize);

    document.getElementById("page-info").innerText =
      `Page ${page} of ${Math.ceil(filtered.length / pageSize)}`;

    tbl.innerHTML = pageData.map(r => {
      const dir = scoreDirection[r.pid];
      let arrow = "";

      if (dir === "up") {
        arrow = `<span class="score-move score-up">↑</span>`;
      } else if (dir === "down") {
        arrow = `<span class="score-move score-down">↓</span>`;
      }

      return `
        <tr data-pid="${r.pid}">
          <td>${r.rank}</td>
          <td>${r.pid}</td>
          <td>${r.score} ${arrow}</td>
          <td>${r.avg}</td>
          <td>${r.sharpe}</td>
          <td>${r.sortino}</td>
        </tr>
      `;
    }).join("");

    requestAnimationFrame(() => playFLIP(prevPositions));
  }

  /* ---------- Controls ---------- */
  function manualRefresh() {
    renderTable();
    document.getElementById("last-updated").innerText =
      "Last Updated: " + formatNow();
  }

  function nextPage() {
    if (page < Math.ceil(filtered.length / pageSize)) {
      page++;
      renderTable();
    }
  }

  function prevPage() {
    if (page > 1) {
      page--;
      renderTable();
    }
  }
</script>

</body>
</html>
