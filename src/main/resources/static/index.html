<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title> ðŸ“Š PMS Leaderboard</title>

  <style>
    /* Previous styling kept, shortened here for clarity */
    body { font-family: Arial; background:#f4f7f9; padding:20px; }
    table { width:95%; margin:auto; border-collapse:collapse; background:white; }
    th, td { padding:10px; text-align:center; border-bottom:1px solid #ddd; }
    thead { background:#1f6feb; color:white; }
    tr.highlight { animation: flash 1.2s ease; }
    @keyframes flash { 0%{background:#fff3a2;} 100%{background:white;} }

    .move-up { animation: moveUp .6s; }
    .move-down { animation: moveDown .6s; }
    @keyframes moveUp { 0%{transform:translateY(10px);} 100%{transform:translateY(0);} }
    @keyframes moveDown { 0%{transform:translateY(-10px);} 100%{transform:translateY(0);} }

    .controls { width:95%; margin:10px auto; display:flex; justify-content:space-between; }
    input { padding:8px; width:280px; }
    button { padding:8px 14px; margin:0 4px; }
  </style>
</head>
<body>

<h2 style="text-align:center;"> Live Portfolio Leaderboard</h2>

<div class="controls">
  <input type="text" id="search" placeholder="Search by Portfolio ID..." oninput="applyFilter()" />
  <div>
    <button onclick="prevPage()">Prev</button>
    <span id="page-info"></span>
    <button onclick="nextPage()">Next</button>
  </div>
</div>

<table>
  <thead>
    <tr>
      <th>Rank</th>
      <th>Portfolio ID</th>
      <th>Composite Score</th>
      <th>Avg Return</th>
      <th>Sharpe</th>
      <th>Sortino</th>
      <th>Updated</th>
    </tr>
  </thead>
  <tbody id="tbl"></tbody>
</table>

<script>
  const ws = new WebSocket((location.protocol==="https:" ? "wss:" : "ws:") + "//" + location.host + "/ws/updates");

  let board = {};
  let prevScores = {};
  let lastRanks = {};
  let filtered = [];
  let page = 1;
  const pageSize = 5;

  ws.onmessage = (evt) => {
    const msg = JSON.parse(evt.data);
    if (msg.event === "leaderboardSnapshot") {
      applySnapshot(msg.top);
      applyFilter();
    }
  };

  function applySnapshot(list) {
    list.forEach(u => {
      lastRanks[u.portfolioId] = board[u.portfolioId]?.rank ?? null;
      prevScores[u.portfolioId] = board[u.portfolioId]?.score ?? 0;

      board[u.portfolioId] = {
        pid: u.portfolioId,
        rank: u.rank,
        score: u.compositeScore,
        avg: u.avgReturn,
        sharpe: u.sharpe,
        sortino: u.sortino,
        updated: new Date().toLocaleTimeString()
      };
    });
  }

  function applyFilter() {
    const search = document.getElementById("search").value.toLowerCase();
    filtered = Object.values(board)
      .sort((a, b) => b.score - a.score)
      .filter(r => r.pid.toLowerCase().includes(search));

    renderTable();
  }

  function renderTable() {
    const tbl = document.getElementById("tbl");

    const startIndex = (page - 1) * pageSize;
    const pageData = filtered.slice(startIndex, startIndex + pageSize);

    document.getElementById("page-info").innerText =
        `Page ${page} of ${Math.ceil(filtered.length / pageSize)}`;

    tbl.innerHTML = pageData.map(r => {
      const last = lastRanks[r.pid];
      const cls = last
                ? (r.rank < last ? "move-up" : (r.rank > last ? "move-down" : ""))
                : "";

      return `
        <tr class="${cls} highlight">
          <td>${r.rank}</td>
          <td>${r.pid}</td>
          <td>${r.score}</td>
          <td>${r.avg}</td>
          <td>${r.sharpe}</td>
          <td>${r.sortino}</td>
          <td>${r.updated}</td>
        </tr>
      `;
    }).join("");
  }

  function nextPage() {
    if (page < Math.ceil(filtered.length / pageSize)) { page++; renderTable(); }
  }

  function prevPage() {
    if (page > 1) { page--; renderTable(); }
  }
</script>

</body>
</html>
